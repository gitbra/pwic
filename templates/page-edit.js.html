<script>

	// -------------------------------- Toolbar

	function edit_uncheck(name) {
		document.getElementById(name).checked = false;
	}

	function edit_decorate(tag) {
		return edit_decorate2(tag, tag);
	}

	function edit_decorate2(tagStart, tagEnd) {
		var	ta = document.getElementById('edit_markdown'),
			ss = ta.selectionStart,
			se = ta.selectionEnd;

		// Replace the text by another one
		if (ss == se)
			return false;
		ta.value = ta.value.substr(0, ss) + tagStart + ta.value.substr(ss, se-ss) + tagEnd + ta.value.substr(se);
		ta.selectionStart = ss + tagStart.length;
		ta.selectionEnd = se + tagEnd.length;
		ta.focus();
		return true;
	}

	function edit_link(text) {
		var	ta = document.getElementById('edit_markdown'),
			ss = ta.selectionStart,
			se = ta.selectionEnd;

		// Find the cursors
		if (ss == se)
			return false;

		// Check the current selection for an autolink
		if (ta.value.substr(ss, se-ss).match('^[a-z]{3,5}:\/\/'))
			return edit_decorate2('<', '>');

		// Ask for the link
		url = prompt(text, '');
		if ((url == '') || (url == null))
			return false;
		url = url.trim();
		if (url.match(/^[a-z0-9_\-\.]+(#p[0-9\.]+)?$/i))
			url = '/{{pwic.project}}/' + url.toLowerCase();

		// Replace the text by another one
		ta.value = ta.value.substr(0, ss) + '[' + ta.value.substr(ss, se-ss) + ']('+url+')' + ta.value.substr(se);
		ta.selectionStart = ss;
		ta.selectionEnd = se + 4 + url.length;
		ta.focus();
		return true;
	}

	function edit_prepend(tag) {
		var	ta = document.getElementById('edit_markdown'),
			ss = ta.selectionStart,
			se = ta.selectionEnd;
		if (ss > se)
			ss, se = se, ss

		// Prepend the tag
		appended = 0;
		for (i=se ; i>=0 ; i--)
		{
			if ((i == 0) || (ta.value[i] == "\n"))
			{
				j = (i != 0 ? 1 : 0);
				ta.value = ta.value.substr(0, i+j) + tag + ta.value.substr(i+j);
				appended++;
				if (i <= ss)
					break;
			}
		}
		ta.selectionStart = ss + tag.length;
		ta.selectionEnd = se + appended * tag.length;
		ta.focus();
		return true;
	}

	function edit_table(textCol, textRow) {
		// Get the dimensions of the table
		var ncol = parseInt(prompt(textCol, 0));
		if (isNaN(ncol) || (ncol < 1))
			return false;
		var nrow = parseInt(prompt(textRow, 0));
		if (isNaN(nrow) || (nrow < 1))
			return false;

		// Prepare the associated markdown
		var i, j, buffer = '';
		for (i=0 ; i<nrow ; i++)
		{
			buffer += '|';
			for (j=0 ; j<ncol ; j++)
				buffer += '          |';
			buffer += '\n';
			if (i == 0)
			{
				buffer += '|';
				for (j=0 ; j<ncol ; j++)
					buffer += ' -------- |';
				buffer += '\n';
			}
		}

		// Apply the text
		var	ta = document.getElementById('edit_markdown'),
			se = ta.selectionEnd;
		ta.value = ta.value.substring(0, se) + buffer + ta.value.substring(se);
		return true;
	}

	function edit_footnote() {
		var	ta = document.getElementById('edit_markdown'),
			se = ta.selectionEnd;

		// Search for the highest current footnote
		var	id = 0,
			list = [...ta.value.matchAll(/\[\^([0-9]+)\]/g)];
		list.forEach(function(match){
			var value = parseInt(match[1]);
			if (value > id)
				id = value;
		});

		// Apply the footnote
		ta.value = ta.value.substring(0, se) + ' [^'+(id+1)+']' + ta.value.substring(se) + '\n\n' + '[^'+(id+1)+']: '
		ta.selectionStart = ta.selectionEnd = ta.value.length;
		ta.focus();
		return true;
	}


	// -------------------------------- Editor

	document.getElementById('edit_markdown').onkeydown = function (event) {
		if (event.keyCode == 9)
		{
			var	ta = document.getElementById('edit_markdown'),
				ss = ta.selectionStart,
				se = ta.selectionEnd;

			if (ss == se)
			{
				ta.value = ta.value.substring(0, ss) + "\t" + ta.value.substring(ss);
				ta.selectionStart = ss + 1;
				ta.selectionEnd = ss + 1;
			}
			else
				edit_prepend("\t");
			return false;
		}
		else
			return true;
	};


	// -------------------------------- Submit

	var edit_submittable = false;

	function edit_submit(errorText, errorShutdown, errorPing) {
		// Check the current values
		edit_submittable = (document.getElementById('edit_title').value != '')
						&& (document.getElementById('edit_comment').value != '');
		if (!edit_submittable)
			alert(errorText);
		else
		{
			// First ping-pong the server to make sure that the session is still valid
			var xhr = new XMLHttpRequest();
			xhr.open('GET', '/api/ping');
			xhr.send();
			xhr.onload = function() {
				if ((xhr.status == 200) && (xhr.responseText == 'OK'))
					// OK let's submit the modification to not lose the current work in progress
					document.getElementById('edit_form').submit();
				else
					alert(errorPing);
			};
			xhr.onerror = function() {
				alert(errorShutdown);
			};
		}
	}

	function edit_preview(pageTitle, buttonTitle) {
		var	ta = document.getElementById('edit_markdown'),
			ss = ta.selectionStart,
			se = ta.selectionEnd,
			xhr = new XMLHttpRequest();
		xhr.open('POST', '/api/markdown');
		xhr.send('content='+encodeURI(ss == se ? ta.value : ta.value.substring(ss, se)));
		xhr.onload = function() {
			if ((xhr.status == 200) && (xhr.responseText != ''))
			{
				var page = window.open('');
				page.document.title = pageTitle;
				page.document.body.innerHTML = '\
<html>\
<head>\
	<link rel="stylesheet" type="text/css" href="'+window.location.protocol+'//'+window.location.host+'/static/styles.css" />\
</head>\
<body>\
	<article>\
		<p style="position:fixed; top:0px; right:0px; padding:15px">\
			<input type="button" onclick="window.close()" value="{{pwic.emojis.door}} '+buttonTitle+'" />\
		</p>\
		' + xhr.responseText + '\
	</article>\
</body>\
</html>';
			}
		};
	}


	// -------------------------------- Leave without save

	window.onbeforeunload = function (e) {
		var	msg = 'The current changes may be lost.',
			e = e || window.event;
		if (!edit_submittable)
		{
			if (e)
				e.returnValue = msg;
			return msg;
		}
	};
</script>