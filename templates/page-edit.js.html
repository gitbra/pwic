<script>
	'use strict';

	// -------------------------------- Toolbar

	function edit_uncheck(name) {
		document.getElementById(name).checked = false;
	}

	function edit_decorate(tag) {
		return edit_decorate2(tag, tag);
	}

	function edit_decorate2(tagStart, tagEnd) {
		var	ta = document.getElementById('edit_markdown'),
			ss = ta.selectionStart,
			se = ta.selectionEnd;

		// Replace the text by another one
		if (ss == se)
			return false;
		ta.value = ta.value.substr(0, ss) + tagStart + ta.value.substr(ss, se-ss) + tagEnd + ta.value.substr(se);
		ta.selectionStart = ss + tagStart.length;
		ta.selectionEnd = se + tagEnd.length;
		ta.focus();
		return true;
	}

	function edit_link(text) {
		var	ta = document.getElementById('edit_markdown'),
			ss = ta.selectionStart,
			se = ta.selectionEnd;

		// Find the cursors
		if (ss == se)
			return false;

		// Check the current selection for an autolink
		if (ta.value.substr(ss, se-ss).match('^[a-z]{3,5}:\/\/'))
			return edit_decorate2('<', '>');

		// Ask for the link
		var url = prompt(text, '');
		if ((url == '') || (url == null))
			return false;
		url = url.trim();
		if (url.match(/^[a-z0-9_\-\.]+(#p[0-9\.]+)?$/i))
			url = '/{{pwic.project}}/' + url.toLowerCase();

		// Replace the text by another one
		ta.value = ta.value.substr(0, ss) + '[' + ta.value.substr(ss, se-ss) + ']('+url+')' + ta.value.substr(se);
		ta.selectionStart = ss;
		ta.selectionEnd = se + 4 + url.length;
		ta.focus();
		return true;
	}

	function edit_prepend(tag) {
		var	ta = document.getElementById('edit_markdown'),
			ss = ta.selectionStart,
			se = ta.selectionEnd;
		if (ss > se)
			ss, se = se, ss

		// Prepend the tag
		var appended = 0;
		for (var i=se ; i>=0 ; i--)
		{
			if ((i == 0) || (ta.value[i] == "\n"))
			{
				var j = (i != 0 ? 1 : 0);
				ta.value = ta.value.substr(0, i+j) + tag + ta.value.substr(i+j);
				appended++;
				if (i <= ss)
					break;
			}
		}
		ta.selectionStart = ss + tag.length;
		ta.selectionEnd = se + appended * tag.length;
		ta.focus();
		return true;
	}

	function edit_table(textCol, textRow) {
		// Get the dimensions of the table
		var ncol = parseInt(prompt(textCol, 0));
		if (isNaN(ncol) || (ncol < 1))
			return false;
		var nrow = parseInt(prompt(textRow, 0));
		if (isNaN(nrow) || (nrow < 1))
			return false;

		// Prepare the associated markdown
		var i, j, buffer='';
		for (i=0 ; i<nrow ; i++)
		{
			buffer += '|';
			for (j=0 ; j<ncol ; j++)
				buffer += '          |';
			buffer += '\n';
			if (i == 0)
			{
				buffer += '|';
				for (j=0 ; j<ncol ; j++)
					buffer += ' -------- |';
				buffer += '\n';
			}
		}

		// Apply the text
		var	ta = document.getElementById('edit_markdown'),
			se = ta.selectionEnd;
		ta.value = ta.value.substring(0, se) + buffer + ta.value.substring(se);
		return true;
	}

	function edit_footnote() {
		var	ta = document.getElementById('edit_markdown'),
			se = ta.selectionEnd;

		// Search for the highest current footnote
		var	id = 0,
			list = [...ta.value.matchAll(/\[\^([0-9]+)\]/g)];
		list.forEach(function(match){
			var value = parseInt(match[1]);
			if (value > id)
				id = value;
		});

		// Apply the footnote
		ta.value = ta.value.substring(0, se) + ' [^'+(id+1)+']' + ta.value.substring(se) + '\n\n' + '[^'+(id+1)+']: '
		ta.selectionStart = ta.selectionEnd = ta.value.length;
		ta.focus();
		return true;
	}


	// -------------------------------- Editor

	document.getElementById('edit_markdown').onkeydown = function (event) {
		if (event.keyCode == 9)
		{
			var	ta = document.getElementById('edit_markdown'),
				ss = ta.selectionStart,
				se = ta.selectionEnd;

			if (ss == se)
			{
				ta.value = ta.value.substring(0, ss) + "\t" + ta.value.substring(ss);
				ta.selectionStart = ss + 1;
				ta.selectionEnd = ss + 1;
			}
			else
				edit_prepend("\t");
			return false;
		}
		else
			return true;
	};


	// -------------------------------- File drop

	async function edit_refresh_files() {
		var options = {	method: 'POST',
						headers: {'Content-Type': 'application/x-www-form-urlencoded'},
						body: 'project={{pwic.project|urlencode}}&page={{pwic.page|urlencode}}'};
		try {
			var request = await fetch('/api/document/list', options);
			if (request.ok)
			{
				var	data = await request.json(),
					buffer = '';
				for (var i=0 ; i<data.length ; i++)
				{
					var doc = data[i];
					buffer += '<tr>\
									<td><a href="/{{pwic.project|urlencode}}/{{pwic.page|urlencode}}/document/'+encodeURI(doc['id'])+'/'+doc['filename']+'" target="_blank">'+doc['filename']+'</a></td>\
									<td title="Hash: '+doc['hash']+'">'+doc['size']+'</td>\
									<td class="pwic_desktop">'+doc['mime_icon']+' '+doc['mime']+'</td>\
									<td class="pwic_desktop"><a href="/special/user/'+encodeURI(doc['author'])+'" target="_blank">'+doc['author']+'</a></td>\
									<td>'+doc['date']+'</td>\
									<td class="pwic_desktop">'+doc['time']+'</td>\
								</tr>';
				}
				document.getElementById('edit_files_list').innerHTML = edit_files_list_initial + buffer;
			}
		}
		catch (error) {
			console.log(error);
		}
	}

	var edit_files_list_initial = document.getElementById('edit_files_list').innerHTML;
	edit_refresh_files();	//For the initialization

	function edit_drop(event, errorUnsupported) {
		document.getElementById('edit_files_drop').classList.remove('pwic_dragover');
		if (event.dataTransfer.items)
		{
			event.preventDefault();
			event.stopPropagation();
			
			// Create an XHR for each file
			var files = event.dataTransfer.files;
			for (var i=0 ; i<files.length ; i++)
			{
				// Fields
				var form = new FormData();
				form.append('project', '{{pwic.project|escape}}');
				form.append('page', '{{pwic.page|escape}}');
				form.append('content', files[i]);

				// Request
				fetch('/api/document/create', {method: 'POST', body: form})
					.then(function() {
						setTimeout(function() {
							edit_refresh_files();
						}, 2000);
					});
			}
		}
		else
			alert(errorUnsupported);
	}

	function edit_dragover(event) {
		document.getElementById('edit_files_drop').classList.add('pwic_dragover');
		event.preventDefault();
		event.stopPropagation();
	}

	function edit_dragleave(event) {
		document.getElementById('edit_files_drop').classList.remove('pwic_dragover');
		event.preventDefault();
		event.stopPropagation();
	}


	// -------------------------------- Submit

	var edit_submittable = false;

	function edit_submit(errorText, errorShutdown, errorPing) {
		// Check the current values
		edit_submittable = (document.getElementById('edit_title').value != '')
						&& (document.getElementById('edit_comment').value != '');
		if (!edit_submittable)
			alert(errorText);
		else
		{
			// First ping-pong the server to make sure that the session is still valid
			var xhr = new XMLHttpRequest();
			xhr.open('POST', '/api/ping');
			xhr.send();
			xhr.onload = function() {
				if ((xhr.status == 200) && (xhr.responseText == 'OK'))
					// OK let's submit the modification to not lose the current work in progress
					document.getElementById('edit_form').submit();
				else
					alert(errorPing);
			};
			xhr.onerror = function() {
				alert(errorShutdown);
			};
		}
	}

	function edit_preview(pageTitle, buttonTitle) {
		var	ta = document.getElementById('edit_markdown'),
			ss = ta.selectionStart,
			se = ta.selectionEnd,
			xhr = new XMLHttpRequest();
		xhr.open('POST', '/api/markdown');
		xhr.send('content='+encodeURI(ss == se ? ta.value : ta.value.substring(ss, se)));
		xhr.onload = function() {
			if ((xhr.status == 200) && (xhr.responseText != ''))
			{
				var page = window.open('');
				page.document.title = pageTitle;
				page.document.body.innerHTML = '\
<html>\
<head>\
	<link rel="stylesheet" type="text/css" href="'+window.location.protocol+'//'+window.location.host+'/static/styles.css" />\
</head>\
<body>\
	<article>\
		<p style="position:fixed; top:0px; right:0px; padding:15px">\
			<input type="button" onclick="window.close()" value="{{pwic.emojis.door}} '+buttonTitle+'" />\
		</p>\
		' + xhr.responseText + '\
	</article>\
</body>\
</html>';
			}
		};
	}


	// -------------------------------- Leave without save

	window.onbeforeunload = function (e) {
		var	msg = 'The current changes may be lost.',
			e = e || window.event;
		if (!edit_submittable)
		{
			if (e)
				e.returnValue = msg;
			return msg;
		}
	};
</script>